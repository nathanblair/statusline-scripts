#!/bin/bash

# $BLOCK_INSTANCE will correspond to battery instance number
#$1 will be a flag to report with icon
#$2 will be a flag to report battery percentage back

[[ ! -z $BLOCK_INSTANCE ]] && battery_instance=$BLOCK_INSTANCE || battery_instance=0

battery_capacity=$(cat /sys/class/power_supply/BAT${battery_instance}/capacity)
battery_status=$(cat /sys/class/power_supply/BAT${battery_instance}/status)

acpi_bat_num=$(($battery_instance + 1))
battery_time=$(acpi -b | awk -v acpi_bat_num=$((battery_instance + 1)) 'NR == acpi_bat_num {print $5}')
[[ -z $battery_time ]] || battery_time="($(date -d ${battery_time} +%_H:%M))"

if [ $1 -eq 1 ]; then
	if [ $battery_status = "Full" ]; then
		battery_text=' ' && color="FFFFFF"
	elif [ $battery_status = "Unknown" ]; then
		battery_text=' ' && color="FFFFFF"
	elif [ $battery_status = "Discharging" ]; then
		((battery_capacity <= 5)) &&
			battery_text=' ' && color="FF0000"
		((battery_capacity > 5 && battery_capacity <=25)) &&
			battery_text=' ' && color="FF6600"
		((battery_capacity > 25 && battery_capacity <=50)) &&
			battery_text=' ' && color="FFAE00"
		((battery_capacity > 50 && battery_capacity <=75)) &&
			battery_text=' ' && color="FFF600"
		((battery_capacity > 75 && battery_capacity <=100)) &&
			battery_text=' ' && color="A8FF00"
	elif [ $battery_status = "Charging" ]; then
		((battery_capacity <= 5)) &&
			battery_text=' ' && color="FF0000"
		((battery_capacity > 5 && battery_capacity <=25)) &&
			battery_text=' ' && color="FF6600"
		((battery_capacity > 25 && battery_capacity <=50)) &&
			battery_text=' ' && color="FFAE00"
		((battery_capacity > 50 && battery_capacity <=75)) &&
			battery_text=' ' && color="FFF600"
		((battery_capacity > 75 && battery_capacity <=100)) &&
			battery_text=' ' && color="A8FF00"
	fi
else
	if [ $battery_status = "Full" ]; then
		battery_text="Full " && color="FFFFFF"
	elif [ $battery_status = "Unknown" ]; then
		battery_text="UNK " && color="FFFFFF"
	elif [ $battery_status = "Discharging" ]; then
		battery_text+="DIS "
	elif [ $battery_status = "Charging" ]; then
		battery_text+="CHR"
	fi
fi

if [ $2 -eq 1 ]; then
	battery_text+=${battery_capacity}%
fi

echo "$battery_text $battery_time"
echo $battery_text
if [ $3 -eq 1 ]; then echo $color; fi

